# 项目对齐文档（ALIGNMENT）

## 1. 项目上下文分析

### 1.1 项目结构

项目是一个名为"智能垃圾分类系统"的后端服务，采用Node.js开发。项目目录结构如下：

```
backend/
├── server.js                # Express服务器入口文件
├── src/
│   ├── app.js              # Koa应用配置文件
│   ├── config/             # 配置文件目录
│   ├── controllers/        # 控制器目录
│   ├── lang/               # 国际化语言文件
│   ├── middlewares/        # 中间件目录
│   ├── models/             # 数据模型目录
│   ├── routes/             # 路由配置目录
│   ├── services/           # 业务服务目录
│   └── utils/              # 工具函数目录
```

### 1.2 技术栈

项目同时包含了Express和Koa两种框架，存在混合使用的情况：

- **主要框架**：
  - Express.js (v4.18.2) - 实际运行的服务器框架
  - Koa.js - 存在于代码库中但未被server.js使用

- **数据库**：
  - MySQL (mysql2 v3.6.5)

- **核心依赖**：
  - jsonwebtoken - JWT认证
  - helmet - 安全头部设置
  - express-rate-limit - 请求限流
  - multer - 文件上传处理
  - joi - 数据验证
  - sharp - 图像处理
  - swagger-ui-express - API文档

### 1.3 架构模式

项目采用了经典的MVC架构模式：
- **控制器(Controllers)**：处理请求逻辑
- **服务(Services)**：实现核心业务逻辑
- **模型(Models)**：数据访问和存储
- **路由(Routes)**：定义API端点
- **中间件(Middlewares)**：处理请求前/后的逻辑

### 1.4 依赖关系

存在一些明显的依赖问题：
- 项目安装了Express依赖，但代码中同时存在Koa的实现
- 部分中间件（如security.js、upload.js）使用Koa的语法，但实际运行的是Express服务器
- server.js中使用了原生的Express中间件配置，未使用app.js中的Koa配置

## 2. 需求理解确认

### 2.1 原始需求

基于代码分析，该项目主要目标是提供一个智能垃圾分类系统的后端API，核心功能包括：

- 垃圾图像识别
- 垃圾信息搜索
- 垃圾类别管理
- 用户识别历史记录
- 系统统计功能

### 2.2 功能模块

已实现的主要功能模块：

1. **垃圾识别模块**：通过图像识别垃圾类型
2. **信息查询模块**：搜索和获取垃圾类别信息
3. **用户记录模块**：管理用户的垃圾识别历史
4. **管理统计模块**：提供管理员视角的系统统计和记录管理

### 2.3 边界确认

当前项目存在以下边界问题：
- 框架混用导致的不兼容性
- 部分中间件尚未完全从Koa迁移到Express
- 部分路由和控制器实现不匹配当前运行的框架

## 3. 智能决策策略

基于项目现状，需要做出以下决策：

1. **框架统一**：选择Express作为主要框架，因为server.js实际使用的是Express
2. **中间件迁移**：将所有Koa风格的中间件迁移到Express风格
3. **控制器适配**：修改所有Koa风格的控制器为Express风格
4. **配置文件统一**：整合配置文件，确保一致性

## 4. 最终共识

### 4.1 需求描述

智能垃圾分类系统后端服务，提供垃圾识别、信息查询、历史记录管理等功能，采用Express.js作为主要框架。

### 4.2 技术实现方案

1. 统一使用Express.js框架
2. 迁移所有Koa中间件到Express
3. 修改控制器以适配Express的请求/响应模型
4. 保持现有的业务逻辑和数据结构

### 4.3 任务边界

- 完成框架统一和代码迁移
- 确保所有API端点正常工作
- 修复现有代码中的错误
- 保留项目原有的业务功能

### 4.4 验收标准

- 项目能够成功启动
- 所有API端点可以正常访问
- 垃圾识别功能正常工作
- 没有框架兼容性错误