<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½åƒåœ¾åˆ†ç±» - APIæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-section {
            border: 2px dashed #3498db;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-sync {
            background-color: #3498db;
            color: white;
        }
        .btn-sync:hover {
            background-color: #2980b9;
        }
        .btn-async {
            background-color: #e74c3c;
            color: white;
        }
        .btn-async:hover {
            background-color: #c0392b;
        }
        .btn-status {
            background-color: #f39c12;
            color: white;
        }
        .btn-status:hover {
            background-color: #e67e22;
        }
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 8px;
            display: none;
        }
        .result-section.show {
            display: block;
        }
        .result-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            background-color: #fadbd8;
            border: 1px solid #e74c3c;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            color: #27ae60;
            background-color: #d5f4e6;
            border: 1px solid #27ae60;
            padding: 10px;
            border-radius: 4px;
        }
        .preview-image {
            max-width: 300px;
            max-height: 300px;
            margin: 10px auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .task-id {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AIæ™ºèƒ½åƒåœ¾åˆ†ç±»ç³»ç»Ÿ</h1>
        

        <div class="upload-section">
            <div class="form-group">
                <label for="imageInput">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶:</label>
                <input type="file" id="imageInput" accept="image/*" onchange="previewImage()">
            </div>
            <div id="imagePreview"></div>
        </div>

        <div class="form-group">
            <label for="languageSelect">è¯­è¨€ / Language / Bahasa:</label>
            <select id="languageSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
                <option value="zh">ä¸­æ–‡ (Chinese)</option>
                <option value="en">English</option>
                <option value="ms">Bahasa Malaysia</option>
            </select>
        </div>

        <div class="button-group">
            <button class="btn-sync" onclick="classifySync()">ğŸš€ åŒæ­¥åˆ†ç±»</button>
            <button class="btn-async" onclick="classifyAsync()">â° å¼‚æ­¥åˆ†ç±»</button>
            <button class="btn-status" onclick="checkStatus()">ğŸ“Š æŸ¥è¯¢çŠ¶æ€</button>
        </div>

        <div id="asyncTaskId" style="margin-top: 10px; display: none;">
            <label>å½“å‰ä»»åŠ¡ID:</label>
            <span id="taskIdDisplay" class="task-id"></span>
        </div>

        <div id="resultSection" class="result-section">
            <h3>åˆ†ç±»ç»“æœ:</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://43.217.144.41:5001';
        let currentTaskId = null;

        function previewImage() {
            const input = document.getElementById('imageInput');
            const preview = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showResult(content, isError = false) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');

            resultContent.innerHTML = content;
            resultSection.classList.add('show');

            if (isError) {
                resultContent.className = 'error';
            } else {
                resultContent.className = 'success';
            }
        }

        function showLoading(message) {
            showResult(`<div class="loading">${message}</div>`);
        }

        function formatAPIResult(apiResponse) {
            if (apiResponse.code !== 0) {
                // é”™è¯¯å“åº”
                let errorContent = `<div class="error">âŒ ${apiResponse.msg}</div>`;
                if (apiResponse.data && apiResponse.data.suggestions) {
                    errorContent += '<div class="result-item"><strong>ğŸ’¡ å»ºè®®:</strong><ul>';
                    apiResponse.data.suggestions.forEach(suggestion => {
                        errorContent += `<li>${suggestion}</li>`;
                    });
                    errorContent += '</ul></div>';
                }

                return errorContent;
            }

            // æˆåŠŸå“åº”
            const result = apiResponse.data;
            if (!result) {
                return `<div class="success">âœ… ${apiResponse.msg}</div>`;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç±»æ•°æ®
            const classification = result.classification;
            if (classification) {
                return `
                    <div class="success">âœ… ${apiResponse.msg}</div>
                    <div class="result-item"><strong>ğŸ—‚ï¸ åƒåœ¾åç§°:</strong> ${classification.waste_name || 'æœªçŸ¥'}</div>
                    <div class="result-item"><strong>ğŸ“‹ åˆ†ç±»:</strong> ${classification.category_name || 'æœªçŸ¥'}</div>
                    <div class="result-item"><strong>ğŸ” åˆ†ç±»ä¾æ®:</strong> ${classification.classification_reason || 'æ— '}</div>
                    <div class="result-item"><strong>â™»ï¸ å¤„ç†å»ºè®®:</strong> ${classification.disposal_advice || 'æ— '}</div>
                    <div class="result-item"><strong>ğŸŒ± ç¯ä¿æç¤º:</strong> ${classification.environmental_tip || 'æ— '}</div>
                    <div class="result-item"><strong>ğŸ“Š ç½®ä¿¡åº¦:</strong> ${((classification.confidence || 0) * 100).toFixed(1)}%</div>
                    <div class="result-item"><strong>âš¡ å¤„ç†æ–¹å¼:</strong> ${result.api_info?.method || result.method || 'sync'}</div>
                    <div class="result-item"><strong>ğŸ¤– AIæ¨¡å‹:</strong> ${result.api_info?.model || 'Amazon Nova Pro'}</div>
                    <div class="result-item"><strong>ğŸŒ è¯­è¨€:</strong> ${apiResponse.lang || 'zh'}</div>
                    ${result.processing_info ? `
                        <div class="result-item">
                            <strong>ğŸ“‹ å¤„ç†ä¿¡æ¯:</strong>
                            <ul>
                                <li>åŸå§‹å¤§å°: ${result.processing_info.original_size_mb}MB</li>
                                <li>æœ€ç»ˆå¤§å°: ${result.processing_info.final_size_mb}MB</li>
                                <li>æ˜¯å¦å‹ç¼©: ${result.processing_info.compressed ? 'æ˜¯' : 'å¦'}</li>
                                <li>æ ¼å¼è½¬æ¢: ${result.processing_info.format_converted ? 'æ˜¯' : 'å¦'}</li>
                            </ul>
                        </div>
                    ` : ''}
                `;
            } else {
                return `
                    <div class="success">âœ… ${apiResponse.msg}</div>
                    <div class="result-item"><strong>ğŸ—‚ï¸ åƒåœ¾åç§°:</strong> ${result.waste_name || 'æœªçŸ¥'}</div>
                    <div class="result-item"><strong>ğŸ“‹ åˆ†ç±»:</strong> ${result.category_name || 'æœªçŸ¥'}</div>
                    <div class="result-item"><strong>ğŸ” åˆ†ç±»ä¾æ®:</strong> ${result.classification_reason || 'æ— '}</div>
                    <div class="result-item"><strong>â™»ï¸ å¤„ç†å»ºè®®:</strong> ${result.disposal_advice || 'æ— '}</div>
                    <div class="result-item"><strong>ğŸŒ± ç¯ä¿æç¤º:</strong> ${result.environmental_tip || 'æ— '}</div>
                    <div class="result-item"><strong>ğŸ“Š ç½®ä¿¡åº¦:</strong> ${((result.confidence || 0) * 100).toFixed(1)}%</div>
                    <div class="result-item"><strong>âš¡ å¤„ç†æ–¹å¼:</strong> ${result.method || 'unknown'}</div>
                    <div class="result-item"><strong>ğŸŒ è¯­è¨€:</strong> ${apiResponse.lang || 'zh'}</div>
                `;
            }
        }

        async function classifySync() {
            const input = document.getElementById('imageInput');
            if (!input.files || !input.files[0]) {
                showResult('<div class="error">è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>', true);
                return;
            }

            showLoading('ğŸ”„ æ­£åœ¨è¿›è¡ŒåŒæ­¥åˆ†ç±»åˆ†æ...');

            const formData = new FormData();
            formData.append('image', input.files[0]);

            const lang = document.getElementById('languageSelect').value;
            formData.append('lang', lang);

            try {
                const response = await fetch(`${API_BASE}/classify`, {
                    method: 'POST',
                    body: formData
                });

                const apiResult = await response.json();
                console.log('API Response:', apiResult);

                const formattedContent = formatAPIResult(apiResult);
                showResult(formattedContent, apiResult.code !== 0);

            } catch (error) {
                showResult(`<div class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`, true);
            }
        }

        async function classifyAsync() {
            const input = document.getElementById('imageInput');
            if (!input.files || !input.files[0]) {
                showResult('<div class="error">è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>', true);
                return;
            }

            showLoading('ğŸ“¤ æ­£åœ¨æäº¤å¼‚æ­¥ä»»åŠ¡...');

            const formData = new FormData();
            formData.append('image', input.files[0]);

            const lang = document.getElementById('languageSelect').value;
            formData.append('lang', lang);

            try {
                const response = await fetch(`${API_BASE}/classify/async`, {
                    method: 'POST',
                    body: formData
                });

                const apiResult = await response.json();
                console.log('Async API Response:', apiResult);

                if (response.status === 202 && apiResult.code === 0) {
                    // å¼‚æ­¥ä»»åŠ¡æˆåŠŸæäº¤
                    currentTaskId = apiResult.data.task_id;
                    document.getElementById('taskIdDisplay').textContent = currentTaskId;
                    document.getElementById('asyncTaskId').style.display = 'block';

                    showResult(`
                        <div class="success">
                            âœ… ${apiResult.msg}<br>
                            ä»»åŠ¡ID: <span class="task-id">${currentTaskId}</span><br>
                            <small>ç‚¹å‡»"æŸ¥è¯¢çŠ¶æ€"æŒ‰é’®æŸ¥çœ‹è¿›åº¦</small>
                        </div>
                    `);

                    pollTaskStatus();
                } else {
                    const formattedContent = formatAPIResult(apiResult);
                    showResult(formattedContent, true);
                }

            } catch (error) {
                showResult(`<div class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`, true);
            }
        }

        async function checkStatus() {
            if (!currentTaskId) {
                showResult('<div class="error">æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„å¼‚æ­¥ä»»åŠ¡</div>', true);
                return;
            }

            showLoading('ğŸ”„ æ­£åœ¨æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€...');

            try {
                const lang = document.getElementById('languageSelect').value;
                const response = await fetch(`${API_BASE}/status/${currentTaskId}?lang=${lang}`);
                const apiResult = await response.json();
                console.log('Status API Response:', apiResult);

                if (apiResult.code === 0) {
                    const taskData = apiResult.data;

                    if (taskData.status === 'completed') {
                        const resultContent = formatAPIResult({
                            code: 0,
                            msg: apiResult.msg,
                            data: taskData.result,
                            lang: apiResult.lang
                        });
                        showResult(resultContent);
                        currentTaskId = null;
                        document.getElementById('asyncTaskId').style.display = 'none';
                    } else if (taskData.status === 'failed') {
                        showResult(`<div class="error">âŒ ${apiResult.msg}: ${taskData.error_details || 'æœªçŸ¥é”™è¯¯'}</div>`, true);
                        currentTaskId = null;
                        document.getElementById('asyncTaskId').style.display = 'none';
                    } else {
                        showResult(`
                            <div class="loading">
                                â³ ${apiResult.msg}<br>
                                ä»»åŠ¡çŠ¶æ€: ${taskData.status}<br>
                                åˆ›å»ºæ—¶é—´: ${taskData.created_time}<br>
                                ${taskData.start_time ? `å¼€å§‹æ—¶é—´: ${taskData.start_time}` : ''}
                            </div>
                        `);
                    }
                } else {
                    const formattedContent = formatAPIResult(apiResult);
                    showResult(formattedContent, true);
                }

            } catch (error) {
                showResult(`<div class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`, true);
            }
        }

        async function pollTaskStatus() {
            if (!currentTaskId) return;

            setTimeout(async () => {
                if (!currentTaskId) return;

                try {
                    const lang = document.getElementById('languageSelect').value;
                    const response = await fetch(`${API_BASE}/status/${currentTaskId}?lang=${lang}`);
                    const apiResult = await response.json();

                    if (apiResult.code === 0) {
                        const taskData = apiResult.data;

                        if (taskData.status === 'completed') {
                            const resultContent = formatAPIResult({
                                code: 0,
                                msg: apiResult.msg,
                                data: taskData.result,
                                lang: apiResult.lang
                            });
                            showResult(resultContent);
                            currentTaskId = null;
                            document.getElementById('asyncTaskId').style.display = 'none';
                        } else if (taskData.status === 'failed') {
                            showResult(`<div class="error">âŒ ${apiResult.msg}: ${taskData.error_details || 'æœªçŸ¥é”™è¯¯'}</div>`, true);
                            currentTaskId = null;
                            document.getElementById('asyncTaskId').style.display = 'none';
                        } else if (taskData.status === 'processing') {
                            showResult(`<div class="loading">ğŸ”„ ${apiResult.msg}</div>`);
                            pollTaskStatus();
                        } else {
                            pollTaskStatus();
                        }
                    } else {
                        console.error('è½®è¯¢APIé”™è¯¯:', apiResult);
                        pollTaskStatus();
                    }
                } catch (error) {
                    console.error('è½®è¯¢é”™è¯¯:', error);
                    pollTaskStatus();
                }
            }, 3000);
        }

        
        window.onload = async function() {
            try {
                const lang = document.getElementById('languageSelect') ?
                    document.getElementById('languageSelect').value : 'zh';
                const response = await fetch(`${API_BASE}/health?lang=${lang}`);
                if (response.ok) {
                    console.log('âœ… APIæœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                } else {
                    console.warn('âš ï¸ APIæœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                console.error('âŒ æ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨: python api_server.py');
            }
        };
    </script>
</body>
</html>